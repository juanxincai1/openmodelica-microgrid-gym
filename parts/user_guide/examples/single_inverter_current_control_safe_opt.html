<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Single Inverter Current Control &mdash; OpenModelica Microgrid 2020 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Two Inverter Static Droop Control" href="two_inverter_static_droop_control.html" />
    <link rel="prev" title="Creating plots of environment variables" href="plotting.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> OpenModelica Microgrid
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../OpenModelica.html">OpenModelica</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fmu.html">Functional Mock-up Unit (FMU)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pythoncode.html">Toolbox Installation and General Remarks</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="creating_env.html">Creating an environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_agent.html">Creating an agent and a runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="plotting.html">Creating plots of environment variables</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Single Inverter Current Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="two_inverter_static_droop_control.html">Two Inverter Static Droop Control</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../controller_tuning.html">Controller Tuning Hints</a></li>
</ul>
<p class="caption"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/omg.agents.html">omg.agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/omg.aux_ctl.html">omg.aux_ctl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/omg.env.html">omg.env</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/omg.execution.html">omg.execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/omg.net.html">omg.net</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/omg.util.html">omg.util</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OpenModelica Microgrid</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../examples.html">Examples</a> &raquo;</li>
      <li>Single Inverter Current Control</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/parts/user_guide/examples/single_inverter_current_control_safe_opt.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="single-inverter-current-control">
<h1>Single Inverter Current Control<a class="headerlink" href="#single-inverter-current-control" title="Permalink to this headline">¶</a></h1>
<p>In this example a three phase inverter is supplying a load (rl1) via a filter (lc1)
like shown in the figure below. From that model a FMU is
built to create the environment.</p>
<div class="figure align-default">
<img alt="../../../_images/Model.png" src="../../../_images/Model.png" />
</div>
<p>An optimization method developed by <a class="reference external" href="https://arxiv.org/abs/1509.01066">Berkenkamp et al.</a> called Safe Controller Optimization (safeopt) is used which takes a Gaussian process and Bayesian
optimization to safely determine “optimal” controller parameters. The
goal of the standard PI current controller is to supply an exemplary 15 A d-current
to the load.</p>
<p>The <a class="reference external" href="fmu.html">generated FMU</a> is used in the environment to build up
a gym env like the examples from OpenAI Gym (<a class="reference external" href="https://gym.openai.com/">https://gym.openai.com/</a>).
The gym enviroment is defined in (examples/single_inverter_current_control_safe_opt.py).
It generates a gym environment using</p>
<ul class="simple">
<li><p>a reward function,</p></li>
<li><p>plotting the inductor values (current) from the lc1-filter (which should be controlled) like shown in the figure below,</p></li>
<li><p>simulating 300 timesteps of delta_t of the FMU grid.network_singleInverter.fmu (generated from the model in the plot above),</p></li>
<li><p>using the setpoints for the inverters (modulation indices) i1p{1,2,3} as inputs,</p></li>
<li><p>and the inductor currents and capacitor voltages of lc1-filter as outputs.</p></li>
</ul>
<div class="figure align-default">
<img alt="../../../_images/i_abc_bk_kp15_Ki121.png" src="../../../_images/i_abc_bk_kp15_Ki121.png" />
</div>
<p>The agent used in this simple RL-example is taken from the class
<code class="code docutils literal notranslate"><span class="pre">SafeOptAgent</span></code>. It contains the controller a
<code class="code docutils literal notranslate"><span class="pre">MultiPhaseDQCurrentSourcingController</span></code>, which consists of multiphase
(3) PI controllers to control the current across the inductor of the
lc1-filter. There are also droop controllers implemented to calculate
e.g. the frequency drop due to load changes. The agent’s task is to find better
parameters for the current controllers (Kp &amp; Ki). Therefore, they are
defined as mutable_params (e.g.
examples/single_inverter_current_control_safe_opt.py) to
adopt them between the episodes. The SafeOpt algorithm uses a Gaussian
process to estimate the performance of the controller. Thus, the
bounds and the lengthscale (c.f. examples/single_inverter_current_control_safe_opt.py) for
the gain parameters (Kp and Ki) have to be defined.</p>
<p>One can adjust one of the parameters (Kp or Ki) (1D case) or both of them
(2D case) using the algorithm. Therefore, the following flag parameters have to
be adjusted accoridngly:</p>
<ul class="simple">
<li><p>To adjust only Kp set <code class="code docutils literal notranslate"><span class="pre">adjust</span> <span class="pre">=</span> <span class="pre">'Kp'</span></code></p></li>
<li><p>To adjust only Ki set <code class="code docutils literal notranslate"><span class="pre">adjust</span> <span class="pre">=</span> <span class="pre">'Kp'</span></code></p></li>
<li><p>To adjust only Kp and Ki set <code class="code docutils literal notranslate"><span class="pre">adjust</span> <span class="pre">=</span> <span class="pre">'Kpi'</span></code></p></li>
</ul>
<p>Due to SafeOpt the agent need a safe starting point (Kp and Ki). Then it
tries to calculate safely parameters with better performance. The
performance is calculated using the reward function from the environment.
There the mean-root-error (RME) from the measured currents and the setpoints are
calculated. Additionally a barrier function is used to penalize
over-currents. The barrier function can be adjusted using the parameter mu.</p>
<p>The safe threshold for the agent is set as safe_threshold-times of
the initial performance (c.f. agents/safeopt.py). For example,
safe_threshold = 1.2 and the initial reward is -10 the safe threshold
would be -12.</p>
<p>In the end of the script a <code class="code docutils literal notranslate"><span class="pre">Runner</span></code> is used to execute 10 episodes
using the agent to control the environment. For every episode the
controlled currents and the performance function as a function of Kp
and/or Ki are plotted.</p>
<p>Some exemplary results are shown below:</p>
<ul class="simple">
<li><p>If <code class="code docutils literal notranslate"><span class="pre">adjust</span> <span class="pre">==</span> <span class="pre">'Kp'</span></code>, the agent tries to
find an optimal value for the proportional gain (Kp) of the
controller in the range of [0, 0.03] with a
lengthscale of 0.01. In the figure below on the x-axis is
the value for Kp and on the y-axis the performance value calculated
using the reward function mentioned above.</p></li>
</ul>
<div class="figure align-default">
<img alt="../../../_images/kp_J.png" src="../../../_images/kp_J.png" />
</div>
<ul class="simple">
<li><p>If <code class="code docutils literal notranslate"><span class="pre">adjust</span> <span class="pre">==</span> <span class="pre">'Ki'</span></code>, the agent tries to
find an optimal value for the integral gain (Ki) of the controller in
the range of [0, 300]  with a lengthscale of 50. In the figure below on the x-axis is the value for Ki and
on the y-axis the performance value calculated using the reward
function mentioned above.</p></li>
</ul>
<div class="figure align-default">
<img alt="../../../_images/ki_J.png" src="../../../_images/ki_J.png" />
</div>
<p>The - due to the algorithm - “unsafe” point on the right (for Kp as well
as for Ki) is not due to overcurrent but due to bad performance due to
permanent control error. The resulting currents for Kp = 0.01 and Ki = 0 (“unsafe” point on the right in the figure above)
is shown in the picture below. Due to the high error compared to the
reference value (15 A d-current), the performance is as bad as the
algorithm defines it as unsafe - in comparison to the performance
reached using the initial controller parameters.</p>
<div class="figure align-default">
<img alt="../../../_images/i_abc_ki_J_bad.png" src="../../../_images/i_abc_ki_J_bad.png" />
</div>
<ul class="simple">
<li><p>If <code class="code docutils literal notranslate"><span class="pre">adjust</span> <span class="pre">==</span> <span class="pre">'Kpi'</span></code>, the agent tries to
find an optimal value for the proportional gain (Kp) as well as for
the integral gain (Ki) of the controller in the ranges of [0, 0.03]
and a lengthscale of 0.01 for Kp and a range of [0, 300] and a
lengthscale of 50 for Ki. In the figure below on the x-axis is the
value for Kp, the y-axis the value for Ki and the z-axis the
performance value calculated using the reward function.</p></li>
</ul>
<div class="figure align-default">
<img alt="../../../_images/kp_ki_J.png" src="../../../_images/kp_ki_J.png" />
</div>
<p>The results of the algorithm are printed into the console in the form
like below:</p>
<p>Iteration, performance J, Params [Kp, Ki]</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="n">J</span>                                      <span class="n">Params</span>
<span class="mi">0</span>  <span class="o">-</span><span class="mf">0.527522</span>                                <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
<span class="mi">1</span>  <span class="o">-</span><span class="mf">0.442648</span>    <span class="p">[</span><span class="mf">0.01517286546392185</span><span class="p">,</span> <span class="mf">14.85163114970222</span><span class="p">]</span>
<span class="mi">2</span>  <span class="o">-</span><span class="mf">0.318154</span>    <span class="p">[</span><span class="mf">0.01426989823624961</span><span class="p">,</span> <span class="mf">44.96747682456248</span><span class="p">]</span>
<span class="mi">3</span>  <span class="o">-</span><span class="mf">0.296940</span>   <span class="p">[</span><span class="mf">0.007935547159879385</span><span class="p">,</span> <span class="mf">63.12800825929393</span><span class="p">]</span>
<span class="mi">4</span>  <span class="o">-</span><span class="mf">0.286636</span>    <span class="p">[</span><span class="mf">0.01482713453607815</span><span class="p">,</span> <span class="mf">88.70170996759624</span><span class="p">]</span>
<span class="mi">5</span>  <span class="o">-</span><span class="mf">0.286815</span>  <span class="p">[</span><span class="mf">0.006770598304777539</span><span class="p">,</span> <span class="mf">108.12303673537075</span><span class="p">]</span>
<span class="mi">6</span>  <span class="o">-</span><span class="mf">0.280167</span>  <span class="p">[</span><span class="mf">0.013261084415467694</span><span class="p">,</span> <span class="mf">135.24448051372738</span><span class="p">]</span>
<span class="mi">7</span>  <span class="o">-</span><span class="mf">0.313204</span>   <span class="p">[</span><span class="mf">0.02201710533671064</span><span class="p">,</span> <span class="mf">56.446583269542394</span><span class="p">]</span>
<span class="mi">8</span>  <span class="o">-</span><span class="mf">1.387003</span>  <span class="p">[</span><span class="mf">0.022868977920736434</span><span class="p">,</span> <span class="mf">108.40140778199653</span><span class="p">]</span>
<span class="mi">9</span>  <span class="o">-</span><span class="mf">0.304403</span>   <span class="p">[</span><span class="mf">0.002145673177669012</span><span class="p">,</span> <span class="mf">55.14569829606201</span><span class="p">]</span>
<span class="mi">10</span> <span class="o">-</span><span class="mf">0.480421</span>   <span class="p">[</span><span class="mf">0.026197353734745858</span><span class="p">,</span> <span class="mf">22.29566509028389</span><span class="p">]</span>
<span class="mi">11</span> <span class="o">-</span><span class="mf">1.097157</span>  <span class="p">[</span><span class="mf">0.0055262530542335535</span><span class="p">,</span> <span class="mf">157.4879776902759</span><span class="p">]</span>
<span class="mi">12</span> <span class="o">-</span><span class="mf">0.391706</span>                    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">17.86728037560901</span><span class="p">]</span>
<span class="mi">13</span> <span class="o">-</span><span class="mf">1.307038</span>                    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">106.0724160092763</span><span class="p">]</span>
<span class="mi">14</span> <span class="o">-</span><span class="mf">1.561142</span>                    <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">42.1020413015999</span><span class="p">]</span>
</pre></div>
</div>
<p>The best performance in this short example of -0.280167 produces the
parameter set of Kp = 0.0132… and Ki = 135.244…</p>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="plotting.html" class="btn btn-neutral float-left" title="Creating plots of environment variables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="two_inverter_static_droop_control.html" class="btn btn-neutral float-right" title="Two Inverter Static Droop Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Bode, Heid, Wallscheid, Weber.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>